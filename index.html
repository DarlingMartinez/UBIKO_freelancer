<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Encuesta - Abastecimiento</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 20px; }
        .step { display: none; }
        .active { display: block; }
        .btn { padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; margin-right: 10px; }
        .btn:disabled { background: gray; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .button { padding: 10px 15px; background: #1294b4; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; }
        .btn_1 { padding: 10px 15px; background: #ff0000; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Modal */
        .modalFondo { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
        .modalContenido { background:white; padding:25px; width:350px; border-radius:10px; max-height: 90vh; overflow-y: auto; }
        
        /* Tabla */
        #tablaProductos th, #tablaProductos td { padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 12px; }
        #tablaProductos th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container" id="mainFormContainer">
        <h2>Formulario de Encuesta</h2>

        <div class="step active" id="step1">
            <label>Encuestador:</label>
            <select id="encuestador">
                <option value="">Seleccione encuestador...</option>
                <option value="1">Encuestador 1</option>
                <option value="2">Encuestador 2</option>
                <option value="3">Encuestador 3</option>
                <option value="4">Encuestador 4</option>
                <option value="5">Encuestador 5</option>
                <option value="6">Encuestador 6</option>
                <option value="7">Encuestador 7</option>
                <option value="8">Encuestador 8</option>
                <option value="9">Encuestador 9</option>
                <option value="10">Encuestador 10</option>
            </select>

            <label>Fecha:</label>
            <input type="date" id="fecha">

            <label>Localidad:</label>
            <select id="localidad" onchange="cargarPlazas()">
                <option value="">Seleccione localidad...</option>
                <option value="TUNJUELITO">TUNJUELITO</option>
                <option value="ANTONIO NARIÑO">ANTONIO NARIÑO</option>
                <option value="PUENTE ARANDA">PUENTE ARANDA</option>
                <option value="SAN CRISTOBAL">SAN CRISTOBAL</option>
                <option value="ENGATIVÁ">ENGATIVÁ</option>
                <option value="KENNEDY">KENNEDY</option>
                <option value="SANTAFÉ">SANTAFÉ</option>
                <option value="FONTIBÓN">FONTIBÓN</option>
                <option value="BARRIOS UNIDOS">BARRIOS UNIDOS</option>
                <option value="LA CANDELARIA">LA CANDELARIA</option>
                <option value="CIUDAD BOLÍVAR">CIUDAD BOLÍVAR</option>
                <option value="MÁRTIRES">MÁRTIRES</option>
            </select>

            <label>Plaza:</label>
            <select id="plaza">
                <option value="">Seleccione una localidad primero...</option>
            </select>

            <button class="btn" onclick="nextStep(1)">Siguiente</button>
        </div>

        <div class="step" id="step2">
            <label>Seleccione el tipo de punto a encuestar:</label>
            <select id="tipoPunto">
                <option value="">Seleccione...</option>
                <option value="plaza">Local dentro de la plaza</option>
                <option value="externo">Local externo</option>
            </select>

            <div id="campoNumLocal" style="display:none;">
                <label>Número del local (dentro de la plaza):</label>
                <input type="text" id="numLocal" placeholder="Ingrese el número del módulo/local">
            </div>

            <div id="campoRefLocalExterno" style="display:none;">
                <label>Nombre o dirección del local externo:</label>
                <input type="text" id="refLocalExterno" placeholder="Ingrese nombre o dirección">
            </div>

            <button class="btn-secondary btn" onclick="prevStep(2)">Atrás</button>
            <button class="btn" onclick="goToProductsScreen()">Siguiente</button>
        </div>
    </div>

    <div class="container" id="pantallaAgregarProductos" style="display:none;">
        <div style="font-size:16px; font-weight:bold; margin-bottom:20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
            <p style="margin: 0;"><span id="infoEncuestador"></span> - <span id="infoFecha"></span></p>
            <p style="margin: 5px 0 0 0;"><span id="infoLocalidad"></span>, <span id="infoPlaza"></span></p>
            <p style="margin: 5px 0 0 0;">Punto: <span id="infoPunto"></span></p>
        </div>

        <center>
            <button class="btn" onclick="abrirModalProducto('new')" style="padding:10px 20px; font-size:16px;">
                + Agregar producto
            </button>
        </center>

        <table id="tablaProductos" border="1" style="margin-top:20px; width:100%; border-collapse:collapse; display:none;">
            <thead>
                <tr style="background:#f0f0f0;">
                    <th>Grupo</th>
                    <th>Producto</th>
                    <th>Canasta</th>
                    <th style="background:#e0f7fa;">Abastecimiento</th>
                    <th style="background:#fff3e0;">Venta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyProductos"></tbody>
        </table>

        <center>
            <button class="btn_1" onclick="cancelarEncuesta()" style="margin-top:20px; padding:12px 25px; font-size:16px;">
                Cancelar
            </button>
            <button class="button" id="btnEnviar" onclick="enviarFormulario()" style="margin-top:20px; padding:12px 25px; font-size:16px; display:none;">
                Enviar
            </button>
            <button class="btn-secondary btn" onclick="backToStep2()">Atrás</button>
        </center>
    </div>

    <div id="modalProducto" class="modalFondo">
        <div class="modalContenido">
            <h3 id="tituloModal">Agregar Producto</h3>
            <input type="hidden" id="editIndex">

            <label>Grupo alimentario:</label>
            <select id="grupoAlimentario" onchange="actualizarListaProductos()">
                <option value="">Seleccione un grupo</option>
                <option value="CARNICOS">CÁRNICOS</option>
                <option value="CEREALES">CEREALES</option>
                <option value="ENDULZANTES">ENDULZANTES</option>
                <option value="FRUTAS">FRUTAS</option>
                <option value="GRANOS">GRANOS</option>
                <option value="GRASAS">GRASAS</option>
                <option value="HIERBAS">HIERBAS</option>
                <option value="HUEVOS">HUEVOS</option>
                <option value="LACTEOS">LÁCTEOS</option>
                <option value="PESCADO">PESCADO</option>
                <option value="PLATANO">PLÁTANO</option>
                <option value="POLLO">POLLO</option>
                <option value="TUBERCULOS">TUBÉRCULOS</option>
                <option value="VERDURAS">VERDURAS</option>
                <option value="OTROS">OTROS</option>
            </select>
            <br>
            <label>Producto:</label>
            <select id="producto">
                <option value="">Seleccione un producto</option>
            </select>
            <p id="avisoCanasta" style="display:none; font-weight:bold; margin-top:5px; color:red;"></p>

            <div id="camposLocalPlaza" style="display:none;">
                <h4 style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 15px;">Datos de **Abastecimiento**</h4>
                
                <label>Unidad de medida:</label>
                <select id="unidadMedidaAbastecimiento" style="width:100%; padding:6px;">
                    <option value="">Seleccione unidad</option>
                    <option value="Lb">Libra</option>
                    <option value="Kg">Kilo</option>
                    <option value="Lt">Litro</option>
                    <option value="Unit">Unidad</option>
                    <option value="Unit">Fragmento</option>
                </select>

                <label>Peso/Volumen:</label>
                <input type="number" id="pesoValorAbastecimiento" placeholder="Ej: 5" min="0" step="any" style="width:100%; padding:6px;">

                <label>Cantidad:</label>
                <input type="number" id="cantidad" placeholder="Ej: 10" min="1" style="width:100%; padding:6px;">

                <label>Unidad de empaque (Abastecimiento):</label>
                <select id="unidadEmpaqueAbastecimiento" style="width:100%; padding:6px;">
                    <option value="">Seleccione...</option>
                    <option value="ATADO">ATADO</option>
                    <option value="BANDEJA">BANDEJA</option>
                    <option value="BULTO">BULTO</option>
                    <option value="CAJA">CAJA</option>
                    <option value="CANASTA">CANASTA</option>
                    <option value="GUACAL">GUACAL</option>
                    <option value="BOLSA">BOLSA</option>
                    <option value="BOTELLA">BOTELLA</option>
                    <option value="OTRO">OTRO</option>
                </select>

                <label>Procedencia:</label>
                <select id="procedencia" style="width:100%; padding:6px;" onchange="manejarProcedencia()">
                    <option value="">Seleccione procedencia</option>
                    <option value="BOGOTÁ">BOGOTÁ</option>
                    <option value="CUNDINAMARCA">CUNDINAMARCA</option>
                    <option value="OTRO">OTRO</option>
                </select>

                <div id="campoProcedenciaOtro" style="display:none; margin-top: 5px;">
                    <input type="text" id="procedenciaOtro" placeholder="Especifique el municipio/departamento" style="width:100%; padding:6px;">
                </div>
                
                <label>Frecuencia de compra:</label>
                <select id="frecuenciaCompra" style="width:100%; padding:6px;">
                    <option value="">Seleccione frecuencia</option>
                    <option value="Diaria">Diaria</option>
                    <option value="Semanal">Semanal</option>
                    <option value="Quincenal">Quincenal</option>
                    <option value="Mensual">Mensual</option>
                </select>

                <div id="camposCanastaPlaza" style="display:none;">
                    <h4 style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 15px;">Datos de **Venta** (Canasta Familiar)</h4>
                    <label>Precio de venta:</label>
                    <input type="number" id="precioVentaCanasta" placeholder="Ej: 3500" min="0" style="width:100%; padding:6px;">
                    <label>Unidad de medida (Kg, Lb, Unit):</label>
                    <select id="unidadMedidaCanasta" style="width:100%; padding:6px;">
                        <option value="">Seleccione unidad de medida</option>
                        <option value="Kg">Kilogramos</option>
                        <option value="Lb">Libras</option>
                        <option value="Unit">Unidad</option>
                    </select>
                    <label>Unidad de empaque:</label>
                    <select id="unidadEmpaqueCanasta" style="width:100%; padding:6px;">
                        <option value="">Seleccione una unidad de empaque</option>
                        <option value="ATADO">ATADO</option>
                        <option value="BANDEJA">BANDEJA</option>
                        <option value="BULTO">BULTO</option>
                        <option value="CAJA">CAJA</option>
                        <option value="CANASTA">CANASTA</option>
                        <option value="GUACAL">GUACAL</option>
                        <option value="BOLSA">BOLSA</option>
                        <option value="BOTELLA">BOTELLA</option>
                    </select>
                </div>
            </div>

            <div id="camposLocalExterno" style="display:none;">
                <label>Precio de venta:</label>
                <input type="number" id="precioVentaExterno" placeholder="Ej: 3500" min="0" style="width:100%; padding:6px;">
                <label>Unidad de medida (Kg, Lb, Unit):</label>
                <select id="unidadMedidaExterno" style="width:100%; padding:6px;">
                    <option value="">Seleccione unidad de medida</option>
                    <option value="Kg">Kilogramos</option>
                    <option value="Lb">Libras</option>
                    <option value="Unit">Unidad</option>
                </select>
                <label>Unidad de empaque:</label>
                <select id="unidadEmpaqueExterno" style="width:100%; padding:6px;">
                    <option value="">Seleccione una unidad de empaque</option>
                    <option value="ATADO">ATADO</option>
                    <option value="BANDEJA">BANDEJA</option>
                    <option value="BULTO">BULTO</option>
                    <option value="CAJA">CAJA</option>
                    <option value="CANASTA">CANASTA</option>
                    <option value="GUACAL">GUACAL</option>
                    <option value="BOLSA">BOLSA</option>
                    <option value="BOTELLA">BOTELLA</option>
                </select>
            </div>

            <br><br>
            <center>
                <button class="btn" onclick="guardarProducto()">Guardar</button>
                <button class="btn_1" onclick="cerrarModalProducto()">Cancelar</button>
            </center>
        </div>
    </div>

    <script>
        /* --- CONSTANTES --- */
        const plazasPorLocalidad = {
            "TUNJUELITO": ["PDM EL CARMEN", "PDM SAN BENITO", "PDM SAN CARLOS"],
            "ANTONIO NARIÑO": ["PDM CARLOS RESTREPO", "PDM SANTANDER"],
            "PUENTE ARANDA": ["PDM TRINIDAD GALAN"],
            "SAN CRISTOBAL": ["PDM 20 DE JULIO"],
            "ENGATIVÁ": ["PDM LAS FERIAS", "PDM QUIRIGUA"],
            "KENNEDY": ["PDM KENNEDY"],
            "SANTAFÉ": ["PDM LAS CRUCES", "PDM PERSEVERANCIA"],
            "FONTIBÓN": ["PDM FONTIBON"],
            "BARRIOS UNIDOS": ["PDM SIETE DE AGOSTO", "PDM DOCE DE OCTUBRE"],
            "LA CANDELARIA": ["PDM LA CONCORDIA"],
            "CIUDAD BOLÍVAR": ["PDM LOS LUCEROS"],
            "MÁRTIRES": ["PDM SAMPER MENDOZA"]
        };

        const productosCanasta = [
            "CAFÉ", "CHOCOLATE", "PASTA", "HARINA", "MOJARRA", "GENERAL", "PECHUGA", "TOMATE",
            "ZANAHORIA", "CEBOLLA LARGA", "CILANTRO", "YUCA", "PAPA", "HUEVOS", "LECHE", "QUESO",
            "ACEITE", "LENTEJAS", "FRIJOL", "NARANJA", "PAPAYA", "BANANO", "SAL", "PANELA",
            "AZUCAR", "ARROZ", "LOMO", "CHATAS"
        ];

        const productosPorGrupo = {
            CARNICOS: ["CADERA", "CANAL", "CHATAS", "COSTILLA", "FALDA", "LOMO", "PIERNA", "SOBREBARRIGA"],
            CEREALES: ["ARROZ", "TRIGO", "AVENA"],
            ENDULZANTES: ["SAL", "PANELA", "AZUCAR"],
            FRUTAS: ["AGUACATE", "AGUACATE HASS", "BANANO", "CURUBA", "DURAZNO", "FRESA", "GRANADILLA", "GUANÁBANA", "GUAYABA", "LIMÓN", "MANDARINA", "MANGO", "MORA", "PAPAYA", "PIÑA", "PERA", "UVA", "NARANJA"],
            GRANOS: ["GARBANZO", "LENTEJAS", "FRIJOL", "MAIZ"],
            GRASAS: ["ACEITE", "MANTEQUILLA"],
            HIERBAS: ["CILANTRO"],
            HUEVOS: ["HUEVOS"],
            LACTEOS: ["LECHE", "QUESO", "YOGURTH", "CUAJADA"],
            PESCADO: ["MOJARRA"],
            PLATANO: ["GENERAL"],
            POLLO: ["PECHUGA"],
            TUBERCULOS: ["ARRACACHA", "PAPA", "YUCA"],
            VERDURAS: ["ACELGA", "AHUYAMA", "AJO", "APIO", "ARVEJA VERDE", "BRÓCOLI", "CALABACÍN/ ZUCHINI", "CEBOLLA CABEZONA", "CEBOLLA LARGA", "COLIFLOR", "ESPINACA", "HABICHUELA", "LECHUGA", "PEPINO COHOMBRO", "PIMENTÓN", "REMOLACHA", "TOMATE", "ZANAHORIA"],
            OTROS: ["CAFÉ", "CHOCOLATE", "PASTA", "HARINA"]
        };

        let listaProductos = []; 
        let tipoDePuntoGlobal = ""; 

        /* --- NAVEGACIÓN --- */
        document.getElementById("tipoPunto").addEventListener("change", function() {
            const tipo = this.value;
            document.getElementById("campoNumLocal").style.display = tipo === 'plaza' ? 'block' : 'none';
            document.getElementById("campoRefLocalExterno").style.display = tipo === 'externo' ? 'block' : 'none';
        });

        function cargarPlazas() {
            const localidad = document.getElementById("localidad").value;
            const plazaSelect = document.getElementById("plaza");
            plazaSelect.innerHTML = `<option value="" disabled selected>Seleccione una plaza</option>`;
            if (!localidad) return;
            plazasPorLocalidad[localidad].forEach(plaza => {
                const option = document.createElement("option");
                option.value = plaza;
                option.textContent = plaza;
                plazaSelect.appendChild(option);
            });
        }

        function nextStep(step) {
            const encuestador = document.getElementById("encuestador").value;
            const fecha = document.getElementById("fecha").value;
            const localidad = document.getElementById("localidad").value;
            const plaza = document.getElementById("plaza").value;
            if (!encuestador || !fecha || !localidad || !plaza) {
                alert("Por favor complete todos los campos de esta sección.");
                return;
            }
            document.getElementById("step" + step).classList.remove("active");
            document.getElementById("step" + (step + 1)).classList.add("active");
        }

        function prevStep(step) {
            document.getElementById("step" + step).classList.remove("active");
            document.getElementById("step" + (step - 1)).classList.add("active");
        }

        function backToStep2() {
            document.getElementById("pantallaAgregarProductos").style.display = "none";
            document.getElementById("mainFormContainer").style.display = "block";
            document.getElementById("step2").classList.add("active");
            document.getElementById("step1").classList.remove("active");
        }

        function goToProductsScreen() {
            const tipoPunto = document.getElementById("tipoPunto").value;
            tipoDePuntoGlobal = tipoPunto; 
            if (!tipoPunto) { alert("Seleccione un tipo de punto."); return; }

            if (tipoPunto === 'plaza') {
                const numLocal = document.getElementById("numLocal").value;
                if (!numLocal) { alert("Ingrese el número del local."); return; }
            } else if (tipoPunto === 'externo') {
                const refLocalExterno = document.getElementById("refLocalExterno").value;
                if (!refLocalExterno) { alert("Ingrese el nombre o dirección del local externo."); return; }
            }

            document.getElementById("mainFormContainer").style.display = "none";
            document.getElementById("pantallaAgregarProductos").style.display = "block";

            document.getElementById("infoEncuestador").textContent = "Encuestador: " + document.getElementById("encuestador").value;
            document.getElementById("infoFecha").textContent = "Fecha: " + document.getElementById("fecha").value;
            document.getElementById("infoLocalidad").textContent = "Localidad: " + document.getElementById("localidad").value;
            document.getElementById("infoPlaza").textContent = "Plaza: " + document.getElementById("plaza").value;

            if (tipoPunto === 'plaza') {
                document.getElementById("infoPunto").textContent = "Local Plaza #" + document.getElementById("numLocal").value;
            } else {
                document.getElementById("infoPunto").textContent = "Local Externo: " + document.getElementById("refLocalExterno").value;
            }
            mostrarTabla();
        }

        function cancelarEncuesta() {
            if (confirm("¿Está seguro de cancelar? Se perderán los productos agregados.")) {
                listaProductos = [];
                document.getElementById("mainFormContainer").style.display = "block";
                document.getElementById("pantallaAgregarProductos").style.display = "none";
                document.getElementById("step1").classList.add("active");
                document.getElementById("step2").classList.remove("active");
            }
        }

        /* --- MODAL Y PRODUCTOS --- */
        function manejarProcedencia() {
            const procedencia = document.getElementById("procedencia").value;
            const campoOtro = document.getElementById("campoProcedenciaOtro");
            if (procedencia === 'OTRO') {
                campoOtro.style.display = 'block';
            } else {
                campoOtro.style.display = 'none';
                document.getElementById("procedenciaOtro").value = '';
            }
        }

        function abrirModalProducto(mode = 'new', index = null) {
            document.getElementById("modalProducto").style.display = "flex";
            document.getElementById("camposLocalPlaza").style.display = tipoDePuntoGlobal === 'plaza' ? 'block' : 'none';
            document.getElementById("camposLocalExterno").style.display = tipoDePuntoGlobal === 'externo' ? 'block' : 'none';
            document.getElementById("camposCanastaPlaza").style.display = 'none';

            if (mode === 'new') {
                document.getElementById("tituloModal").textContent = "Agregar Producto";
                document.getElementById("editIndex").value = "";
                document.getElementById("grupoAlimentario").value = "";
                actualizarListaProductos();
                document.getElementById("producto").value = "";
                document.getElementById("avisoCanasta").style.display = "none";

                // Limpiar campos plaza
                document.getElementById("unidadMedidaAbastecimiento").value = "";
                document.getElementById("pesoValorAbastecimiento").value = "";
                document.getElementById("cantidad").value = "";
                document.getElementById("unidadEmpaqueAbastecimiento").value = "";
                document.getElementById("procedencia").value = "";
                document.getElementById("procedenciaOtro").value = "";
                document.getElementById("frecuenciaCompra").value = "";
                document.getElementById("campoProcedenciaOtro").style.display = "none";

                // Limpiar campos venta
                document.getElementById("precioVentaCanasta").value = "";
                document.getElementById("unidadEmpaqueCanasta").value = "";
                document.getElementById("unidadMedidaCanasta").value = ""; 
                document.getElementById("precioVentaExterno").value = "";
                document.getElementById("unidadMedidaExterno").value = "";
                document.getElementById("unidadEmpaqueExterno").value = "";

            } else if (mode === 'edit' && index !== null) {
                editarProducto(index);
            }
        }

        function cerrarModalProducto() {
            document.getElementById("modalProducto").style.display = "none";
        }

        function actualizarListaProductos() {
            const grupo = document.getElementById("grupoAlimentario").value;
            const selectProducto = document.getElementById("producto");
            selectProducto.innerHTML = `<option value="">Seleccione un producto</option>`;

            if (grupo && productosPorGrupo[grupo]) {
                productosPorGrupo[grupo].forEach(p => {
                    if (tipoDePuntoGlobal === 'externo' && !productosCanasta.includes(p.toUpperCase())) return;
                    const opt = document.createElement("option");
                    opt.value = p;
                    opt.textContent = p;
                    selectProducto.appendChild(opt);
                });
            }
            selectProducto.dispatchEvent(new Event('change'));
        }

        document.getElementById("producto").addEventListener("change", function () {
            const aviso = document.getElementById("avisoCanasta");
            const producto = this.value;
            const esCanasta = productosCanasta.includes(producto.toUpperCase());
            const camposCanastaPlaza = document.getElementById("camposCanastaPlaza");

            if (esCanasta) {
                aviso.textContent = "✓ Pertenece a la canasta familiar";
                aviso.style.display = "block";
                if (tipoDePuntoGlobal === 'plaza') camposCanastaPlaza.style.display = "block";
            } else {
                aviso.style.display = "none";
                if (tipoDePuntoGlobal === 'plaza') camposCanastaPlaza.style.display = "none";
            }
            
            if (tipoDePuntoGlobal === 'externo' && !esCanasta && producto) {
                alert("Para locales externos, solo se permite información de productos de la canasta familiar.");
                this.value = "";
            }
        });

        function guardarProducto() {
            let grupo = document.getElementById("grupoAlimentario").value;
            let producto = document.getElementById("producto").value;
            let editIndex = document.getElementById("editIndex").value;

            if (!grupo || !producto) { alert("Seleccione Grupo y Producto."); return; }

            const esCanasta = productosCanasta.includes(producto.toUpperCase());
            let obj = { grupo, producto, canasta: esCanasta ? "Sí" : "No", tipoPunto: tipoDePuntoGlobal };

            if (tipoDePuntoGlobal === 'plaza') {
                // MODIFICACIÓN: Capturar el nuevo campo de empaque y la procedencia corregida
                const unidadMedidaAbastecimiento = document.getElementById("unidadMedidaAbastecimiento").value;
                const pesoValorAbastecimiento = document.getElementById("pesoValorAbastecimiento").value;
                const cantidad = document.getElementById("cantidad").value;
                const unidadEmpaqueAbastecimiento = document.getElementById("unidadEmpaqueAbastecimiento").value;
                let procedencia = document.getElementById("procedencia").value;
                const frecuenciaCompra = document.getElementById("frecuenciaCompra").value;

                // Validación "OTRO" en procedencia
                if (procedencia === "OTRO") {
                    procedencia = document.getElementById("procedenciaOtro").value.toUpperCase();
                    if(!procedencia) { alert("Especifique la procedencia."); return; }
                }

                if (!unidadMedidaAbastecimiento || !pesoValorAbastecimiento || !cantidad || !unidadEmpaqueAbastecimiento || !procedencia || !frecuenciaCompra) {
                    alert("Complete todos los campos de Abastecimiento (incluyendo Unidad de Empaque).");
                    return;
                }

                Object.assign(obj, { unidadMedidaAbastecimiento, pesoValorAbastecimiento, cantidad, unidadEmpaqueAbastecimiento, procedencia, frecuenciaCompra });

                if (esCanasta) {
                    const precioVentaCanasta = document.getElementById("precioVentaCanasta").value;
                    const unidadMedidaCanasta = document.getElementById("unidadMedidaCanasta").value; 
                    const unidadEmpaqueCanasta = document.getElementById("unidadEmpaqueCanasta").value;
                    if (!precioVentaCanasta || !unidadMedidaCanasta || !unidadEmpaqueCanasta) {
                        alert("Complete Datos de Venta."); return;
                    }
                    Object.assign(obj, { precioVenta: precioVentaCanasta, unidadMedida: unidadMedidaCanasta, unidadEmpaque: unidadEmpaqueCanasta });
                } else {
                    Object.assign(obj, { precioVenta: "N/A", unidadMedida: "N/A", unidadEmpaque: "N/A" });
                }

            } else if (tipoDePuntoGlobal === 'externo') {
                const precioVentaExterno = document.getElementById("precioVentaExterno").value;
                const unidadMedidaExterno = document.getElementById("unidadMedidaExterno").value;
                const unidadEmpaqueExterno = document.getElementById("unidadEmpaqueExterno").value;

                if (!precioVentaExterno || !unidadMedidaExterno || !unidadEmpaqueExterno) {
                    alert("Complete Precio, Unidad Medida y Empaque."); return;
                }
                Object.assign(obj, {
                    precioVenta: precioVentaExterno, unidadMedida: unidadMedidaExterno, unidadEmpaque: unidadEmpaqueExterno,
                    unidadMedidaAbastecimiento: "N/A", pesoValorAbastecimiento: "N/A", cantidad: "N/A", unidadEmpaqueAbastecimiento: "N/A", procedencia: "N/A", frecuenciaCompra: "N/A"
                });
            }

            if (editIndex === "") listaProductos.push(obj);
            else listaProductos[editIndex] = obj;

            mostrarTabla();
            cerrarModalProducto();
        }

        function mostrarTabla() {
            const tabla = document.getElementById("tablaProductos");
            const tbody = document.getElementById("tbodyProductos");
            const btnEnviar = document.getElementById("btnEnviar");

            tbody.innerHTML = "";
            listaProductos.forEach((p, index) => {
                let abastecimientoColumna = p.tipoPunto === 'plaza' ? 
                    `Peso/Vol: <b>${p.pesoValorAbastecimiento} ${p.unidadMedidaAbastecimiento}</b><br>Cant.: <b>${p.cantidad}</b><br>Empaque: <b>${p.unidadEmpaqueAbastecimiento}</b><br>Procedencia: <b>${p.procedencia}</b><br>Frec.: <b>${p.frecuenciaCompra}</b>` 
                    : `N/A`;

                let ventaColumna = (p.tipoPunto === 'externo' || p.canasta === "Sí") ? 
                    `Precio: <b>$${p.precioVenta}</b><br>Uni. Med.: <b>${p.unidadMedida}</b><br>Uni. Emp.: <b>${p.unidadEmpaque}</b>`
                    : `N/A`;

                let fila = `<tr>
                    <td>${p.grupo}</td><td>${p.producto}</td><td>${p.canasta}</td>
                    <td style="background:#e0f7fa;">${abastecimientoColumna}</td>
                    <td style="background:#fff3e0;">${ventaColumna}</td>
                    <td>
                        <button class="btn" style="margin:2px;" onclick="abrirModalProducto('edit', ${index})">Editar</button>
                        <button class="btn_1" style="margin:2px;" onclick="eliminarProducto(${index})">Eliminar</button>
                    </td>
                </tr>`;
                tbody.innerHTML += fila;
            });

            tabla.style.display = listaProductos.length > 0 ? "table" : "none";
            btnEnviar.style.display = listaProductos.length > 0 ? "inline-block" : "none";
        }

        function editarProducto(i) {
            let p = listaProductos[i];
            document.getElementById("grupoAlimentario").value = p.grupo;
            actualizarListaProductos();

            setTimeout(() => {
                document.getElementById("producto").value = p.producto;

                if (p.tipoPunto === 'plaza') {
                    document.getElementById("unidadMedidaAbastecimiento").value = p.unidadMedidaAbastecimiento;
                    document.getElementById("pesoValorAbastecimiento").value = p.pesoValorAbastecimiento;
                    document.getElementById("cantidad").value = p.cantidad;
                    document.getElementById("unidadEmpaqueAbastecimiento").value = p.unidadEmpaqueAbastecimiento; // Cargar nuevo campo
                    
                    // Logica para cargar procedencia OTRO
                    const esProcedenciaEstandar = ["BOGOTÁ", "CUNDINAMARCA", "OTRO"].includes(p.procedencia);
                    if (esProcedenciaEstandar && p.procedencia !== "OTRO") {
                         document.getElementById("procedencia").value = p.procedencia;
                         document.getElementById("campoProcedenciaOtro").style.display = "none";
                    } else {
                         // Asumimos que es una procedencia personalizada
                         document.getElementById("procedencia").value = "OTRO";
                         document.getElementById("campoProcedenciaOtro").style.display = "block";
                         document.getElementById("procedenciaOtro").value = p.procedencia;
                    }
                    
                    document.getElementById("frecuenciaCompra").value = p.frecuenciaCompra;

                    if (p.canasta === 'Sí') {
                        document.getElementById("precioVentaCanasta").value = p.precioVenta;
                        document.getElementById("unidadEmpaqueCanasta").value = p.unidadEmpaque;
                        document.getElementById("unidadMedidaCanasta").value = p.unidadMedida;
                        document.getElementById("camposCanastaPlaza").style.display = "block";
                    }
                } else if (p.tipoPunto === 'externo') {
                    document.getElementById("precioVentaExterno").value = p.precioVenta;
                    document.getElementById("unidadMedidaExterno").value = p.unidadMedida;
                    document.getElementById("unidadEmpaqueExterno").value = p.unidadEmpaque;
                }

                document.getElementById("editIndex").value = i;
                document.getElementById("tituloModal").textContent = "Editar Producto";
                document.getElementById("producto").dispatchEvent(new Event('change'));
            }, 50);
        }

        function eliminarProducto(i) {
            if (confirm("¿Eliminar producto?")) { listaProductos.splice(i, 1); mostrarTabla(); }
        }

        /* --- ENVÍO A GOOGLE SHEETS --- */
        function enviarFormulario() {
            // *** TU URL PROPORCIONADA ***
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfWK2uMmRsrw-q-X1MNS1B0HeWAdnBEqAU6POk_cOPPO27UJ5rgHJ3bsSCOytZTYI7/exec";

            const encuestador = document.getElementById("encuestador").value;
            const fecha = document.getElementById("fecha").value;
            const localidad = document.getElementById("localidad").value;
            const plaza = document.getElementById("plaza").value;
            const tipoPunto = tipoDePuntoGlobal; 
            
            let idLocal = (tipoPunto === 'plaza') ? document.getElementById("numLocal").value : document.getElementById("refLocalExterno").value;

            if (listaProductos.length === 0) { alert("No hay productos."); return; }
            if (!encuestador || !fecha || !localidad) { alert("Faltan datos generales."); return; }

            const btn = document.getElementById("btnEnviar");
            const textoOriginal = btn.textContent;
            btn.disabled = true; btn.textContent = "Enviando...";

            // Mapeo EXACTO a las 17 columnas del Excel
            const datosParaExcel = listaProductos.map(p => {
                return {
                    "ENCUESTADOR": encuestador,
                    "FECHA": fecha,
                    "LOCALIDAD": localidad,
                    "PLAZA": plaza || "N/A",
                    "TIPO_PUNTO": tipoPunto,
                    "ID_LOCAL": idLocal,
                    
                    "GRUPO_ALIMENTARIO": p.grupo,
                    "PRODUCTO": p.producto,
                    "ES_CANASTA": p.canasta,
                    
                    "ABAST_UNIDAD_MEDIDA": p.unidadMedidaAbastecimiento || "",
                    "ABAST_PESO_VOLUMEN": p.pesoValorAbastecimiento || "",
                    "ABAST_CANTIDAD": p.cantidad || "",
                    "ABAST_PROCEDENCIA": p.procedencia || "",
                    "ABAST_FRECUENCIA": p.frecuenciaCompra || "",
                    
                    "VENTA_PRECIO": p.precioVenta !== "N/A" ? p.precioVenta : "",
                    "VENTA_UNIDAD_MEDIDA": p.unidadMedida !== "N/A" ? p.unidadMedida : "",
                    "VENTA_UNIDAD_EMPAQUE": p.unidadEmpaque !== "N/A" ? p.unidadEmpaque : ""
                };
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datosParaExcel)
            })
            .then(response => {
                alert("¡Datos enviados correctamente al Excel!");
                listaProductos = []; mostrarTabla();
                document.getElementById("pantallaAgregarProductos").style.display = "none";
                document.getElementById("mainFormContainer").style.display = "block";
                document.getElementById("step1").classList.add("active");
                document.getElementById("step2").classList.remove("active");
                document.getElementById("numLocal").value = "";
                document.getElementById("refLocalExterno").value = "";
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Hubo un error al enviar los datos.");
            })
            .finally(() => {
                btn.disabled = false; btn.textContent = textoOriginal;
            });
        }
    </script>
</body>
</html>
