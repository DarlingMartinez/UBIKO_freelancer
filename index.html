<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Encuesta - Abastecimiento</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <style>
        /* Estilos CSS Base */
        body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 20px; }
        .step { display: none; }
        .active { display: block; }
        .btn { padding: 10px 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; margin-right: 10px; }
        .btn:disabled { background: gray; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .button { padding: 10px 15px; background: #1294b4; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; }
        .btn_1 { padding: 10px 15px; background: #ff0000; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Tabla de Productos */
        #tablaProductos { width:100%; border-collapse:collapse; table-layout: fixed; }
        #tablaProductos th, #tablaProductos td { 
            padding: 8px; 
            text-align: left; 
            border: 1px solid #ddd; 
            font-size: 12px; 
            vertical-align: middle; 
            box-sizing: border-box;
        }
        #tablaProductos th { background-color: #f2f2f2; font-size: 13px; }
        
        /* Estilos para celdas específicas */
        /* Celda de GRUPO (Rowspan) */
        #tablaProductos td:first-child { 
            background: #e9ecef; 
            font-weight: bold; 
            width: 15%; 
        }
        
        /* Celda de PRODUCTO - AJUSTE PRINCIPAL */
        #tablaProductos td:nth-child(2) { 
            width: 20%; 
            /* Se quita el 'background: white;' genérico de aquí */
            font-weight: bold;
            background-color: white; /* Por defecto, blanco */
        } 

        /* ESTILO SOLICITADO: Fondo Verde para Productos de Canasta Familiar */
        .producto-canasta {
            background-color: #c8e6c9 !important; /* Un verde claro para destacar */
        }
        
        /* Estilo para las celdas de input dentro de la tabla */
        #tablaProductos input, #tablaProductos select { margin: 0; padding: 4px; font-size: 11px; height: 28px; border: 1px solid #ccc; }

        /* Estilo para la unidad fija (Libra) */
        .unidad-fija {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            padding: 4px;
            height: 28px;
            line-height: 20px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        /* Estilos para el Buscador Select2 */
        .select2-container { width: 100% !important; margin-top: 5px; }
        .select2-container .select2-selection--single { height: 38px; padding: 5px; border: 1px solid #ccc; }
        .select2-selection__arrow { height: 36px !important; }
        .select2-container--open { z-index: 9999 !important; }
    </style>
</head>
<body>
    <div class="container" id="mainFormContainer">
        <h2>Formulario de Encuesta</h2>

        <div class="step active" id="step1">
            <label>Encuestador:</label>
            <select id="encuestador">
                <option value="">Seleccione encuestador...</option>
                <option value="1">Encuestador 1</option>
                <option value="2">Encuestador 2</option>
                <option value="3">Encuestador 3</option>
                <option value="4">Encuestador 4</option>
                <option value="5">Encuestador 5</option>
                <option value="6">Encuestador 6</option>
                <option value="7">Encuestador 7</option>
                <option value="8">Encuestador 8</option>
                <option value="9">Encuestador 9</option>
                <option value="10">Encuestador 10</option>
            </select>

            <label>Fecha:</label>
            <input type="date" id="fecha">

            <label>Localidad:</label>
            <select id="localidad" onchange="cargarPlazas()">
                <option value="">Seleccione localidad...</option>
                <option value="TUNJUELITO">TUNJUELITO</option>
                <option value="ANTONIO NARIÑO">ANTONIO NARIÑO</option>
                <option value="PUENTE ARANDA">PUENTE ARANDA</option>
                <option value="SAN CRISTOBAL">SAN CRISTOBAL</option>
                <option value="ENGATIVÁ">ENGATIVÁ</option>
                <option value="KENNEDY">KENNEDY</option>
                <option value="SANTAFÉ">SANTAFÉ</option>
                <option value="FONTIBÓN">FONTIBÓN</option>
                <option value="BARRIOS UNIDOS">BARRIOS UNIDOS</option>
                <option value="LA CANDELARIA">LA CANDELARIA</option>
                <option value="CIUDAD BOLÍVAR">CIUDAD BOLÍVAR</option>
                <option value="MÁRTIRES">MÁRTIRES</option>
            </select>

            <label>Plaza:</label>
            <select id="plaza">
                <option value="">Seleccione una localidad primero...</option>
            </select>
       
            <label>Seleccione el tipo de punto a encuestar:</label>
            <select id="tipoPunto">
                <option value="">Seleccione...</option>
                <option value="plaza">Local dentro de la plaza</option>
                <option value="externo">Local externo</option>
            </select>

            <div id="campoNumLocal" style="display:none;">
                <label>Número del local (dentro de la plaza):</label>
                <input type="text" id="numLocal" placeholder="Ingrese el número del módulo/local">
            </div>

            <div id="campoRefLocalExterno" style="display:none;">
                <label>Nombre o dirección del local externo:</label>
                <input type="text" id="refLocalExterno" placeholder="Ingrese nombre o dirección">
            </div>

            <button class="btn" onclick="goToProductsScreen()">Siguiente</button>
        </div>
    </div>

    <div class="container" id="pantallaAgregarProductos" style="display:none;">
        <div style="font-size:16px; font-weight:bold; margin-bottom:20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
            <p style="margin: 0;"><span id="infoEncuestador"></span> - <span id="infoFecha"></span></p>
            <p style="margin: 5px 0 0 0;"><span id="infoLocalidad"></span>, <span id="infoPlaza"></span></p>
            <p style="margin: 5px 0 0 0;">Punto: <span id="infoPunto"></span></p>
        </div>

        <table id="tablaProductos" border="1" style="margin-top:10px; width:100%; border-collapse:collapse; table-layout: fixed; display:none;">
            <thead>
                <tr style="background:#f0f0f0;">
                    <th style="width:15%;">Grupo</th>
                    <th style="width:20%;">Producto</th>
                    <th style="width:15%;">Cant. / Abast.</th>
                    <th style="width:15%;">Unidad</th>
                    <th style="width:25%;">Observación / Procedencia</th>
                    <th style="width:10%;">Precio $</th>
                </tr>
            </thead>
            <tbody id="tbodyProductos">
                </tbody>
        </table>
   
        <center>
            <button class="btn_1" onclick="cancelarEncuesta()" style="margin-top:20px; padding:12px 25px; font-size:16px;">
                Cancelar
            </button>
            <button class="button" id="btnEnviar" onclick="enviarFormulario()" style="margin-top:20px; padding:12px 25px; font-size:16px; display:none;">
                Enviar
            </button>
            <button class="btn-secondary btn" onclick="goBackToMainForm()">Atrás</button>
        </center>
    </div>

    <script>
        /* ========================================================= */
        /* ===              1. CONSTANTES GLOBALES               === */
        /* ========================================================= */
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzYC10PoSwMAZ204js3j1zh8IIk3zUMcjDuZFsiXZvi57HDtiAd95lqwpHuH4D4xcBK/exec";

        const plazasPorLocalidad = {
            "TUNJUELITO": ["PDM EL CARMEN", "PDM SAN BENITO", "PDM SAN CARLOS"],
            "ANTONIO NARIÑO": ["PDM CARLOS RESTREPO", "PDM SANTANDER"],
            "PUENTE ARANDA": ["PDM TRINIDAD GALAN"],
            "SAN CRISTOBAL": ["PDM 20 DE JULIO"],
            "ENGATIVÁ": ["PDM LAS FERIAS", "PDM QUIRIGUA"],
            "KENNEDY": ["PDM KENNEDY"],
            "SANTAFÉ": ["PDM LAS CRUCES", "PDM PERSEVERANCIA"],
            "FONTIBÓN": ["PDM FONTIBON"],
            "BARRIOS UNIDOS": ["PDM SIETE DE AGOSTO", "PDM DOCE DE OCTUBRE"],
            "LA CANDELARIA": ["PDM LA CONCORDIA"],
            "CIUDAD BOLÍVAR": ["PDM LOS LUCEROS"],
            "MÁRTIRES": ["PDM SAMPER MENDOZA"]
        };
        
        // --- LISTA PLANA DE PRODUCTOS (ESTRUCTURA ORIGINAL) ---
        const listaProductosFijos = [
            // CÁRNICOS
            { grupo: "CÁRNICOS", producto: "CADERA", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "CANAL", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "CHATAS", canasta: "Sí" },
            { grupo: "CÁRNICOS", producto: "COSTILLA", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "FALDA", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "LOMO", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "PIERNA", canasta: "No" },
            { grupo: "CÁRNICOS", producto: "SOBREBARRIGA", canasta: "No" },
            
            // POLLO
            { grupo: "POLLO", producto: "POLLO/PECHUGA", canasta: "No" },
            
            // PESCADO
            { grupo: "PESCADO", producto: "PESCADO/PRECIO MOJARRA", canasta: "No" },
            
            // HUEVOS
            { grupo: "HUEVOS", producto: "HUEVOS", canasta: "Sí" },
            
            // LÁCTEOS
            { grupo: "LÁCTEOS", producto: "LECHE", canasta: "Sí" },
            { grupo: "LÁCTEOS", producto: "QUESO/Gral. Precio queso campesino", canasta: "Sí" },
            { grupo: "LÁCTEOS", producto: "YOGURTH", canasta: "No" },
            { grupo: "LÁCTEOS", producto: "CUAJADA", canasta: "No" },
            
            // FRUTAS
            { grupo: "FRUTAS", producto: "AGUACATE", canasta: "No" },
            { grupo: "FRUTAS", producto: "AGUACATE HASS", canasta: "No" },
            { grupo: "FRUTAS", producto: "BANANO", canasta: "Sí" },
            { grupo: "FRUTAS", producto: "CURUBA", canasta: "No" },
            { grupo: "FRUTAS", producto: "DURAZNO", canasta: "No" },
            { grupo: "FRUTAS", producto: "FRESA", canasta: "No" },
            { grupo: "FRUTAS", producto: "GRANADILLA", canasta: "No" },
            { grupo: "FRUTAS", producto: "GUANÁBANA", canasta: "No" },
            { grupo: "FRUTAS", producto: "GUAYABA", canasta: "No" },
            { grupo: "FRUTAS", producto: "LIMÓN", canasta: "No" },
            { grupo: "FRUTAS", producto: "MANDARINA", canasta: "No" },
            { grupo: "FRUTAS", producto: "MANGO", canasta: "No" },
            { grupo: "FRUTAS", producto: "MORA", canasta: "No" },
            { grupo: "FRUTAS", producto: "PAPAYA", canasta: "Sí" },
            { grupo: "FRUTAS", producto: "PIÑA", canasta: "No" },
            { grupo: "FRUTAS", producto: "PERA", canasta: "No" },
            { grupo: "FRUTAS", producto: "UVA", canasta: "No" },
            { grupo: "FRUTAS", producto: "NARANJA", canasta: "Sí" },
            { grupo: "FRUTAS", producto: "PLÁTANO Gral/Precio Verde y Maduro", canasta: "No" },
            
            // HIERBAS
            { grupo: "HIERBAS", producto: "CILANTRO", canasta: "Sí" }, 
            
            // TUBÉRCULOS
            { grupo: "TUBÉRCULOS", producto: "ARRACACHA", canasta: "No" },
            { grupo: "TUBÉRCULOS", producto: "PAPA/gral. Precio pastusa y criolla", canasta: "Sí" },
            { grupo: "TUBÉRCULOS", producto: "YUCA", canasta: "Sí" },
            
            // VERDURAS
            { grupo: "VERDURAS", producto: "ACELGA", canasta: "No" },
            { grupo: "VERDURAS", producto: "AHUYAMA", canasta: "No" },
            { grupo: "VERDURAS", producto: "AJO", canasta: "No" },
            { grupo: "VERDURAS", producto: "APIO", canasta: "No" },
            { grupo: "VERDURAS", producto: "ARVEJA VERDE", canasta: "No" },
            { grupo: "VERDURAS", producto: "BRÓCOLI", canasta: "No" },
            { grupo: "VERDURAS", producto: "CALABACÍN/ZUCHINI", canasta: "No" },
            { grupo: "VERDURAS", producto: "CEBOLLA CABEZONA", canasta: "No" },
            { grupo: "VERDURAS", producto: "CEBOLLA LARGA", canasta: "Sí" },
            { grupo: "VERDURAS", producto: "COLIFLOR", canasta: "No" },
            { grupo: "VERDURAS", producto: "ESPINACA", canasta: "No" },
            { grupo: "VERDURAS", producto: "HABICHUELA", canasta: "No" },
            { grupo: "VERDURAS", producto: "LECHUGA", canasta: "No" },
            { grupo: "VERDURAS", producto: "PEPINO COHOMBRO", canasta: "No" },
            { grupo: "VERDURAS", producto: "PIMENTÓN", canasta: "No" },
            { grupo: "VERDURAS", producto: "REMOLACHA", canasta: "No" },
            { grupo: "VERDURAS", producto: "TOMATE", canasta: "Sí" },
            { grupo: "VERDURAS", producto: "ZANAHORIA", canasta: "Sí" },
            
            // CEREALES
            { grupo: "CEREALES", producto: "ARROZ", canasta: "Sí" },
            { grupo: "CEREALES", producto: "TRIGO", canasta: "No" },
            { grupo: "CEREALES", producto: "AVENA", canasta: "No" },
            
            // ENDULZANTES
            { grupo: "ENDULZANTES", producto: "SAL", canasta: "Sí" },
            { grupo: "ENDULZANTES", producto: "PANELA", canasta: "Sí" },
            { grupo: "ENDULZANTES", producto: "AZUCAR", canasta: "Sí" },
            
            // GRANOS
            { grupo: "GRANOS", producto: "GARBANZO", canasta: "No" },
            { grupo: "GRANOS", producto: "LENTEJAS", canasta: "Sí" },
            { grupo: "GRANOS", producto: "FRIJOL", canasta: "Sí" },
            { grupo: "GRANOS", producto: "MAÍZ", canasta: "No" },
            
            // GRASAS
            { grupo: "GRASAS", producto: "ACEITE", canasta: "Sí" },
            { grupo: "GRASAS", producto: "MANTEQUILLA", canasta: "No" },
            
            // OTROS
            { grupo: "OTROS", producto: "CAFÉ", canasta: "Sí" },
            { grupo: "OTROS", producto: "CHOCOLATE", canasta: "Sí" },
            { grupo: "OTROS", producto: "PASTA", canasta: "Sí" },
            { grupo: "OTROS", producto: "HARINA", canasta: "Sí" }
        ];

        // Opciones para el <select> de unidades de medida (ya no se usan como select, sino como hidden)
        const unidadesMedida = [
            { value: "Lb", text: "Libra" },
            { value: "Kg", text: "Kilo" },
            { value: "Lt", text: "Litro" },
            { value: "Unit", text: "Unidad" }
        ];

        // Variables de estado global
        let tipoDePuntoGlobal = "";
        let contextoActual = { tipo: "", id: "" };
        
        /* ========================================================= */
        /* ===              2. FUNCIONES DE NAVEGACIÓN           === */
        /* ========================================================= */
        
        // Muestra/Oculta campos de Local/Externo
        document.getElementById("tipoPunto").addEventListener("change", function() {
            const tipo = this.value;
            document.getElementById("campoNumLocal").style.display = tipo === 'plaza' ? 'block' : 'none';
            document.getElementById("campoRefLocalExterno").style.display = tipo === 'externo' ? 'block' : 'none';
        });

        // Carga el <select> de plazas al cambiar la localidad
        function cargarPlazas() {
            const localidad = document.getElementById("localidad").value;
            const plazaSelect = document.getElementById("plaza");
            plazaSelect.innerHTML = `<option value="">Seleccione una plaza</option>`;
            if (!localidad) return;
            plazasPorLocalidad[localidad].forEach(plaza => {
                const option = document.createElement("option");
                option.value = plaza;
                option.textContent = plaza;
                plazaSelect.appendChild(option);
            });
        }
        
        // Lógica para ir a la pantalla de la tabla de productos
        function goToProductsScreen() {
            // 1. Capturar y validar campos generales
            const encuestador = document.getElementById("encuestador").value;
            const fecha = document.getElementById("fecha").value;
            const localidad = document.getElementById("localidad").value;
            const plaza = document.getElementById("plaza").value;
            const nuevoTipoPunto = document.getElementById("tipoPunto").value;
            let nuevoIdLocal = "";

            if (!encuestador || !fecha || !localidad || !plaza) { alert("Complete todos los campos generales."); return; }
            if (!nuevoTipoPunto) { alert("Seleccione un tipo de punto."); return; }

            if (nuevoTipoPunto === 'plaza') {
                nuevoIdLocal = document.getElementById("numLocal").value;
                if (!nuevoIdLocal) { alert("Ingrese el número del local."); return; }
            } else if (nuevoTipoPunto === 'externo') {
                nuevoIdLocal = document.getElementById("refLocalExterno").value;
                if (!nuevoIdLocal) { alert("Ingrese el nombre o dirección del local externo."); return; }
            }

            // 2. Lógica de alerta si se cambia de punto (simplificada)
            const cambioElTipo = (contextoActual.tipo !== "" && contextoActual.tipo !== nuevoTipoPunto);
            const cambioElId = (contextoActual.id !== "" && contextoActual.id !== nuevoIdLocal);

            if (cambioElTipo || cambioElId) {
                alert("⚠️ ATENCIÓN:\n\nHa cambiado el TIPO o ID del PUNTO.\nSe recomienda limpiar los datos ingresados en la tabla de productos.");
            }
            
            // 3. Actualizar estado y variables globales
            contextoActual = { tipo: nuevoTipoPunto, id: nuevoIdLocal };
            tipoDePuntoGlobal = nuevoTipoPunto; 

            // 4. Cambio de Pantalla (Visual)
            document.getElementById("mainFormContainer").style.display = "none";
            document.getElementById("pantallaAgregarProductos").style.display = "block";
            
            // 5. Rellenar cabecera de información
            document.getElementById("infoEncuestador").textContent = "Encuestador: " + encuestador;
            document.getElementById("infoFecha").textContent = "Fecha: " + fecha;
            document.getElementById("infoLocalidad").textContent = "Localidad: " + localidad;
            document.getElementById("infoPlaza").textContent = "Plaza: " + plaza;

            document.getElementById("infoPunto").textContent = nuevoTipoPunto === 'plaza' ? 
                "Local Plaza #" + nuevoIdLocal : "Local Externo: " + nuevoIdLocal;
            
            // 6. Cargar la tabla fija y datos guardados
            cargarTablaFijaDeProductos(); 
            
            // 7. Mostrar botones y guardar estado
            document.getElementById("tablaProductos").style.display = "table";
            document.getElementById("btnEnviar").style.display = "inline-block";
            guardarEstadoLocal();
        }
        
        // Vuelve de la pantalla de productos a la de datos generales
        function goBackToMainForm() {
            document.getElementById("pantallaAgregarProductos").style.display = "none";
            document.getElementById("mainFormContainer").style.display = "block";
        }
        
        // Cancela la encuesta por completo
        function cancelarEncuesta() {
            if (confirm("¿Está seguro de cancelar? Se perderán los datos en la tabla y se reseteará el formulario.")) {
                // Limpiar pantalla de productos
                document.getElementById("tbodyProductos").innerHTML = "";
                
                // Volver a la pantalla de inicio
                document.getElementById("mainFormContainer").style.display = "block";
                document.getElementById("pantallaAgregarProductos").style.display = "none";
                
                // Limpiar storage para evitar la carga de datos del punto anterior
                localStorage.removeItem("encuesta_backup_data"); 
                
                // Resetear campos del formulario (incluyendo Select2)
                document.getElementById("encuestador").value = "";
                document.getElementById("fecha").value = "";
                document.getElementById("localidad").value = "";
                document.getElementById("plaza").value = "";
                document.getElementById("tipoPunto").value = "";
                document.getElementById("tipoPunto").dispatchEvent(new Event('change'));
                document.getElementById("numLocal").value = "";
                document.getElementById("refLocalExterno").value = "";
                
                // Forzar el Select2 a resetear
                $('#encuestador').val('').trigger('change');
                $('#localidad').val('').trigger('change');
            }
        }
        
        
        /* ========================================================= */
        /* ===              3. LÓGICA DE TABLA FIJA (CORREGIDA)  === */
        /* ========================================================= */
        
        // Crea la tabla con los inputs de la lista fija de productos
        function cargarTablaFijaDeProductos() {
            const tbody = document.getElementById("tbodyProductos");
            tbody.innerHTML = "";
            
            listaProductosFijos.forEach((p, index) => {
                // Lógica para no repetir el nombre del GRUPO (Rowspan)
                let grupoHTML = '';
                if (index === 0 || p.grupo !== listaProductosFijos[index - 1].grupo) {
                    const rowspanCount = listaProductosFijos.filter(item => item.grupo === p.grupo).length;
                    grupoHTML = `<td rowspan="${rowspanCount}" style="font-weight: bold; background: #e9ecef;">${p.grupo}</td>`; 
                }

                let obsInputPlaceholder = (tipoDePuntoGlobal === 'plaza') ? "Notas/Origen (Procedencia)" : "Notas";

                // Aplica la clase de fondo verde si es Canasta Familiar
                const productoClase = p.canasta === 'Sí' ? 'producto-canasta' : '';
                
                // Columna UNIDAD es texto fijo "Libra" y se incluye un input hidden
                let unidadHTML = `
                    <div class="unidad-fija">Libra</div>
                    <input type="hidden" id="unidad_${index}" value="Lb">
                `;
                
                let fila = `
                    <tr data-index="${index}" data-grupo="${p.grupo}" data-producto="${p.producto}" data-canasta="${p.canasta}">
                        ${grupoHTML}
                        <td class="${productoClase}">${p.producto}</td>
                        
                        <td>
                            <input type="number" id="cantidad_${index}" placeholder="Cant." min="0" step="any" style="width:100%; text-align:center;" oninput="guardarEstadoLocal()">
                        </td>

                        <td>
                            ${unidadHTML}
                        </td>
                        
                        <td>
                            <input type="text" id="obs_proc_${index}" placeholder="${obsInputPlaceholder}" style="width:100%;" oninput="guardarEstadoLocal()">
                        </td>

                        <td>
                            <input type="number" id="precio_${index}" placeholder="Precio $" min="0" step="100" style="width:100%; text-align:right;" oninput="guardarEstadoLocal()">
                        </td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            });
            
            // Cargar datos de la tabla guardados si existen
            cargarDatosTabla();
        }
        
        // Rellena los inputs de la tabla con los datos guardados en localStorage
        function cargarDatosTabla() {
            const dataGuardada = localStorage.getItem("encuesta_backup_data");
            if (!dataGuardada) return;

            const estado = JSON.parse(dataGuardada);
            const productosData = estado.productosData || [];

            productosData.forEach((p, index) => {
                const cantidadInput = document.getElementById(`cantidad_${index}`);
                // const unidadInput = document.getElementById(`unidad_${index}`); // La unidad es fija 'Lb'
                const obsInput = document.getElementById(`obs_proc_${index}`);
                const precioInput = document.getElementById(`precio_${index}`);

                if (cantidadInput) cantidadInput.value = p.cantidad || '';
                // if (unidadInput) unidadInput.value = 'Lb'; // La unidad es fija
                if (obsInput) obsInput.value = p.obsProcedencia || '';
                if (precioInput) precioInput.value = p.precio || '';
            });
        }
        
        
        /* ========================================================= */
        /* ===               4. ENVÍO DE FORMULARIO              === */
        /* ========================================================= */
        function enviarFormulario() {
            const encuestador = document.getElementById("encuestador").value;
            const fecha = document.getElementById("fecha").value;
            const localidad = document.getElementById("localidad").value;
            const plaza = document.getElementById("plaza").value;
            const tipoPunto = tipoDePuntoGlobal; 
            let idLocal = (tipoPunto === 'plaza') ? document.getElementById("numLocal").value : document.getElementById("refLocalExterno").value;

            const filas = document.getElementById("tbodyProductos").querySelectorAll('tr');
            if (filas.length === 0) { alert("Error: La tabla de productos está vacía."); return; }

            const datosParaExcel = [];
            let hayDatosValidos = false;

            filas.forEach((fila) => {
                const index = fila.getAttribute('data-index'); 
                const grupo = fila.getAttribute('data-grupo');
                const producto = fila.getAttribute('data-producto');
                const canasta = fila.getAttribute('data-canasta') === 'Sí' ? 'Sí' : 'No';
                
                // Obtener los datos de los inputs asociados
                const cantidad = document.getElementById(`cantidad_${index}`).value;
                // Unidad es fija "Lb"
                const unidad = document.getElementById(`unidad_${index}`).value; // Obtiene "Lb" del input hidden
                const obsProcedencia = document.getElementById(`obs_proc_${index}`).value;
                const precio = document.getElementById(`precio_${index}`).value;
                
                // Validar: si hay Cantidad o Precio, se considera un dato para enviar
                if (cantidad || precio) {
                    hayDatosValidos = true;
                    
                    datosParaExcel.push({
                        "ENCUESTADOR": encuestador,
                        "FECHA": fecha,
                        "LOCALIDAD": localidad,
                        "PLAZA": plaza || "N/A",
                        "TIPO_PUNTO": tipoPunto,
                        "ID_LOCAL": idLocal,
                        
                        "GRUPO_ALIMENTARIO": grupo,
                        "PRODUCTO": producto,
                        "ES_CANASTA": canasta,
                        
                        "ABAST_PROCEDENCIA": tipoPunto === 'plaza' ? obsProcedencia : "N/A", 
                        "ABAST_OBSERVACION_PROCEDENCIA": obsProcedencia || "", 
                        
                        "ABAST_CANTIDAD": cantidad || "",
                        "ABAST_UNIDAD_MEDIDA": unidad || "",
                        
                        "VENTA_PRECIO": precio || "",
                        "VENTA_UNIDAD_MEDIDA": unidad || "", 
                        
                        // Campos fijos vacíos para mantener estructura del Excel
                        "ABAST_PESO_VOLUMEN": "", 
                        "ABAST_FRECUENCIA": "",
                        "ABAST_UNIDAD_EMPAQUE": "",
                        "VENTA_UNIDAD_EMPAQUE": "",
                    });
                }
            });
            
            if (!hayDatosValidos) { alert("Debe ingresar datos de Cantidad o Precio en al menos una fila para enviar el formulario."); return; }

            // Lógica de envío y manejo del botón
            const btn = document.getElementById("btnEnviar");
            const textoOriginal = btn.textContent;
            btn.disabled = true; btn.textContent = "Enviando...";
            
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datosParaExcel)
            })
            .then(response => {
                alert("¡Datos enviados correctamente!");
                cancelarEncuesta(); 
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Hubo un error al enviar los datos. Revise la consola.");
            })
            .finally(() => {
                btn.disabled = false; btn.textContent = original;
            });
        }
        
        /* ========================================================= */
        /* ===          5. PERSISTENCIA (Auto-Guardado)          === */
        /* ========================================================= */

        // Captura los datos de los inputs de la tabla
        function getDatosTablaParaGuardar() {
            const filas = document.getElementById("tbodyProductos").querySelectorAll('tr');
            const productosData = [];
            filas.forEach((fila) => {
                const index = fila.getAttribute('data-index');
                
                // Unidad fija
                const unidadValor = 'Lb'; 

                productosData.push({
                    cantidad: document.getElementById(`cantidad_${index}`).value,
                    unidad: unidadValor, // Guardamos el valor fijo
                    obsProcedencia: document.getElementById(`obs_proc_${index}`).value,
                    precio: document.getElementById(`precio_${index}`).value
                });
            });
            return productosData;
        }

        // Guarda todo el estado del formulario en localStorage
        function guardarEstadoLocal() {
            const pasoActual = document.getElementById('pantallaAgregarProductos').style.display === 'block' ? 'productos' : 'step1';

            const estado = {
                encuestador: document.getElementById("encuestador").value,
                fecha: document.getElementById("fecha").value,
                localidad: document.getElementById("localidad").value,
                plaza: document.getElementById("plaza").value,
                tipoPunto: document.getElementById("tipoPunto").value,
                numLocal: document.getElementById("numLocal").value,
                refLocalExterno: document.getElementById("refLocalExterno").value,
                
                tipoDePuntoGlobal: tipoDePuntoGlobal,
                pasoVisual: pasoActual,
                
                productosData: getDatosTablaParaGuardar()
            };

            localStorage.setItem("encuesta_backup_data", JSON.stringify(estado));
        }

        // Carga el estado guardado al iniciar la página
        function cargarEstadoLocal() {
            const dataGuardada = localStorage.getItem("encuesta_backup_data");
            if (!dataGuardada) return;

            const estado = JSON.parse(dataGuardada);
            tipoDePuntoGlobal = estado.tipoDePuntoGlobal || "";
            contextoActual = { 
                tipo: estado.tipoPunto || "", 
                id: (estado.tipoPunto === 'plaza' ? estado.numLocal : estado.refLocalExterno) || ""
            };

            // Restaurar datos generales (primero Select2, luego Selects normales)
            document.getElementById("encuestador").value = estado.encuestador;
            document.getElementById("localidad").value = estado.localidad;
            $('#encuestador').val(estado.encuestador).trigger('change');
            $('#localidad').val(estado.localidad).trigger('change');
            
            document.getElementById("fecha").value = estado.fecha;
            cargarPlazas(); 
            document.getElementById("plaza").value = estado.plaza;

            document.getElementById("tipoPunto").value = estado.tipoPunto;
            document.getElementById("tipoPunto").dispatchEvent(new Event('change')); 
            
            document.getElementById("numLocal").value = estado.numLocal;
            document.getElementById("refLocalExterno").value = estado.refLocalExterno;

            if (estado.pasoVisual === 'productos') {
                // Forzar la navegación a la pantalla de productos si estaba allí
                goToProductsScreen(); 
            }
        }

        
        /* ========================================================= */
        /* ===          6. INICIALIZACIÓN Y SELECT2              === */
        /* ========================================================= */

        document.addEventListener("DOMContentLoaded", () => {
            // Inicializar Select2 en los campos de datos generales (Encuestador y Localidad)
            $(document).ready(function() {
                $('#encuestador, #localidad').select2({
                    placeholder: "Seleccione o busque...",
                    width: '100%'
                });
                
                // Truco visual para el placeholder de búsqueda
                $(document).on('select2:open', function(e) {
                    document.querySelector('.select2-search__field')?.setAttribute('placeholder', 'Buscar...');
                });
                
                // Cargar estado inicial después de Select2
                cargarEstadoLocal();
            });
        });
    </script>
</body>
</html>
